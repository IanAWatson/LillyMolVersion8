# Generating Fragment Libraries from Dicer Fragments
Using fragments extracted from known collections is at the heart of many of the
denovo molecule construction techniques for which LillyMol is used. Curating those
collections of fragments is a critical task in order to support those efforts.

## Tools
The most general way in which molecules can be divided is via [dicer](/docs/Molecule_Tools/dicer.md).
`dicer` is however expensive to run.

If you just want sidechains use [get_substituents](/docs/Molecule_Tools/get_substituents.md) which
can very efficiently extract the sidechains from a collection of molecules.

If you just want linker groups that are the chain atoms between two rings, use get_linker or
possibly smi2linker - these tools have overlapping functionality and will eventually be combined.

In this discussion we focus on using `dicer`, but skip to the section on postprocessing
textproto files if you use one of these other tools for generating the summary textproto
files

## Filtering and Sorting
Running dicer is expensive. It is also somewhat unlikely that fragments will only appear
in larger molecules, so for efficiency we usually choose to filter the collections to
more reasonably sized molecules.

```
dopattern.sh -do c1,c2,c3 fileconv -C 35 -S % /path/to/collection/%.smi
```
where each of the 'c' tokens might be 'chembl', 'enamine', 'corporate'... There is
nothing magic about 35 heavy atoms, it is about 500 MW. This cuts the size of the
molecules, which is something that can significantly slow dicer.

When an exemplar molecule is presented it is desirable that the molecule be
the a small molecule rather than a large molecule where the viewer may need to
hunt around through the structure looking for the relevant group. If we instead
present the smallest known examplar, that can be beneficial. Therefore sort the
collections.

```
dopattern.sh -do c1,c2,c3 'msort_parallel -p -h 12 -k formula %.smi > %.sorted.smi'
```

## Aggregation.
We now need to aggregate the collections. This can of course be done in random order,
```
cat *.sorted.smi > all.smi
```
but if we do that, the exemplar structure for each fragment will be random. Instead
we choose a specific order in which we present the fragments. Use this to take
the opportunity to split the files.

## Dicer
Create a directory in which dicer jobs will be run and split the files in 
order
```
mkdir dicer
cd dicer
iwsplit -suffix smi -n 300000 ../c2.sorted.smi ../c8.sorted.smi ../c1.sorted.smi ...
```
where the ordering, c2 c8 c1 ..., reflects your preference for which collections
you might "trust" more than the others. This ordering does not affect results 
at all, just a human factor.

Select dicer options. For the fragments distributed with LillyMol we use
```
dopattern.sh -cluster -suffix smi 'dicer.sh -M 9 -B nbamide -B brcb \
         -B fragstatproto -B fragstat=%.textproto -B nosmi -B FMC:PROTO:fmc.qry\
         -k 2 -X 500 -c -I atype -P UST:AY %.smi'
```

The -B FMC:PROTO:fmc.qry specifies a query file that specifies constraints
on what is in the fragments generated. That file is
```
query {
  smarts: "0[P,Br,I,B]"
}
```
We wish to exclude these elements from consideration. Given that these sets of
fragments will be used for making new molecules, Phosphorus and Boron are
definitely disfavoured. And as for the Halogens, the Chloro variant is
likely the mos useful variant to generted. These constraints reduces the
size of the fragment files generated by about 10%, which is also desirable.

The agove command generates a bunch of iwsplit*.textproto files containing dicer_data::DicerFragment
protos that might look like
```
smi: "[3001CH4]" par: "EMOL360272237" nat: 1 n: 118165
smi: "[9001CH4]" par: "EMOL360272237" nat: 1 n: 127183
smi: "[3038CH4]" par: "EMOL368594172" nat: 1 n: 200346
smi: "[3038cH]1[3001cH]cccc1" par: "EMOL362691903" nat: 6 n: 23098
smi: "[3001cH]1ccccc1" par: "EMOL2157780" nat: 6 n: 21276'
smi: "F[3038CH](F)F" par: "EMOL352120149" nat: 4 n: 19528
smi: "[12007cH]1cc[9001cH]cc1" par: "SIGMA66509199" nat: 6 n: 1
```

We see that there are 118165 occurrences of a methyl group in one of
the split files that contained EMOL molecules.  These have an
attachment point type of 3001, 127183 occurrences of a methyl where
the attachment is of type 9001.  There are 21276 occurrences of a
singly substitued benzene substituent, 19528 CF3 occurrences of a CF3
bonded to a 3038 atom type.  And last is a para substitued benzene
ring, where is just one occurrence of that group in one of the split
files.

We made an arbitrary decision to truncate at fragments of 8 atoms. Adding just
a single atom to 9 atoms, almost doubles the size of the files generated. Adjust to
taste, but increasing the maximum fragment size also increases the cost of
the calculation.

## Aggregation of TextProto Files.
Once dicer_data::DicerFragment textprotos are available they must
be aggregated. `dicer_fragments_collate` scans individual textproto
files and for each fragment found, increments the count field (n: above)
to reflect the total number of occurrences across all instances. 

Again, we wish to preserve the order in which we placed the molecules
so do this carefully.

```
dicer_fragments_collate -sort -nosmi iwsplit?.textproto iwsplit??.textproto iwsplit???.textproto > all.textproto
```
where we provide the single digit files first, then the two digit files and then the rest.

[!NOTE] The data reported below is from an earlier run that included up to 9 atoms.

We find 1.95M fragments in this file. Of those 519k have just one instance of the fragment.

It might be tempting here to just discard singleton fragments. This will certainly be desirable
for very small sidechains, it will be less desirable for larger sidechains. With the verbose option
added to `dicer_fragments_collate` the following report is written to stderr.

| Natoms | Fragments | Singletons | Fraction |
| ------ | --------- | ---------- | -------- |
| 1 | 125 | 9 | 0.072 |
| 2 | 1019 | 105 | 0.103042 |
| 3 | 4794 | 684 | 0.142678 |
| 4 | 15346 | 2710 | 0.176593 |
| 5 | 44570 | 8528 | 0.191339 |
| 6 | 117784 | 25058 | 0.212745 |
| 7 | 267328 | 63398 | 0.237154 |
| 8 | 538600 | 139470 | 0.258949 |
| 9 | 960555 | 279833 | 0.291324 |

The tool reports
```
519795 singletons, max count_89348
```
As the size of the fragments goes up, so does the proportion of singletons. This
makes sense. The 9 singleton single atom fragments are all horrible. Here are
the 9 in the table above from an earlier run before we excluded the various elements
via the '-B FMC...' option.
```
smi: "[3001PH4+]" par: "SIGMA636882883" nat: 1 n: 1
smi: "[21001IH2+]" par: "MCULE-3922095212" nat: 1 n: 1
smi: "[3038CH3+]" par: "MCULE-4492162698" nat: 1 n: 1
smi: "[9001BrH2+]" par: "ZINC102475492" nat: 1 n: 1
smi: "[9001SH3+]" par: "CHEMBL1173558" nat: 1 n: 1
smi: "[3038OH3+]" par: "SIGMA1214982385" nat: 1 n: 1
smi: "[3001OH3+]" par: "MCULE-7071859740" nat: 1 n: 1
smi: "[3001BrH2+]" par: "SIGMA243347753" nat: 1 n: 1
smi: "[6007NH2-]" par: "SIGMA112860902" nat: 1 n: 1
```
It is possible these might be drawing errors, or possibly a truly rare
stable molecular state? But we would not want to see any of these in generated molecules.

Single atom fragments with just two occurrences are as bad
```
smi: "[12007PH3]" par: "MCULE-6534589915" nat: 1 n: 2
smi: "[3038PH2-]" par: "SIGMA28807050" nat: 1 n: 2
smi: "[3001NH2-]" par: "CHEMBL1591879" nat: 1 n: 2
smi: "[33018IH]" par: "MCULE-3472521017" nat: 1 n: 2
```

Currently there is not a convenient way to impose a support requirement that is
aware of the number of atoms in the fragment.

We see that as the number of atoms in the fragment goes up, so does the number
of fragments found. The near doubling of size during the transition from 8
to 9 atoms resulted in the decision to truncate things at 8 atoms.

## Topological Types
It can be convenient to subdivide the fragments into different types. The tool
dicer_to_topological_types looks at the smiles associated with each fragment
and determins the number of isotopic atoms. Fragments with a single isotope
are potential new substituents, whereas Fragments with two isotopic atoms are
potential new linkers.
```
dicer_to_topological_types.sh -v -S FRAG all.textproto
```

This generates the following files
```
FRAG_1_1.textproto
FRAG_1_2.textproto
FRAG_1_3.textproto
FRAG_1_4.textproto
FRAG_1_5.textproto
FRAG_1_6.textproto
FRAG_1_7.textproto
FRAG_1_8.textproto
FRAG_2_1.textproto
FRAG_2_2.textproto
FRAG_2_3.textproto
FRAG_2_4.textproto
FRAG_2_5.textproto
FRAG_2_6.textproto
FRAG_2_7.textproto
```
The file `FRAG_1_n.textproto' contains fragments with a single attachment point
and `n` atoms. The file `FRAG_2_n.textproto` contains fragments with two attachment
points and `n` bonds between the attachment points. This is the same as `n-1` atoms
between the attachment points.


These files resulting from concatenating some public collections of molecules are
in the tar file included in the LillyMol distribution in
data/dicer_fragments/dicer_fragments.tar.xz. Use
```
tar Jxvf data/dicer_fragments/dicer_fragments.tar.xz
```
to decompress.

Note too that a file of sidechains from Chembl extracted by get_substituents is also
included with the LillyMol distribution [sidechains](/data/chembl_sidechains.textproto).

## trxn
Writing a reaction to append an isotopically labelled sidechain to an existing molecule
can be straightforward.

For example if you wished to replace an existing aniline with a sidechain that
has a Nitrogen with a Hydrogen somewhere in it, first extract candidates from
the FRAG_* files. Possibly
```
tsubstructure -s '[0NH>0]' -m candidates FRAG_1_[2-7].textproto 
```
which looks at just the substituent files with between 2 and 7 atoms. Since those
files are isotopically labelled, and we specified '[0NH>0]' we will not get
matches where the NH is at the attachment point.

Since we are not going to use the specific values of the isotopes here
we discard duplicates.

Some of these files are used as the inputs to minor_changes and dicer_fragment_replace.

