# Linker Replacement

A combination of LillyMol tools can enable linker replacememt.

In order to accomplish linker replacement certain data must be
assembled. This is usually the hard part.

## TLDR
```
# Identify substituents.
rgroup -v -v -X rname -a -I 1 -s 'c12naaa1aaaa2' -r 0.2 -r 0.8 -z i -u file.smi > R.smi
# Convert to two files of substituents
rgroup_to_linker_replace -S R R.smi
# Generate or fetch replacement linker file DICER_2_3.textproto, see below.
# Make new molecules
linker_replacement -L DICER_2_3.textproto R1.smi R2.smi
```

While more generally, a linker group could have any number of connections, the
current tools only support two connected linker groups. It would not
be hard to change that, but it is also not clear that is needed.

Three files of molecules are needed:


## Sidechain Files
The existing sidechains, R1.smi and R2.smi. These must have the same
number of records and might look like: R1.smi

```
[1CH4] CHEMBL1979738
[1OH2] CHEMBL1650264
[1NH3] CHEMBL1500738
F[1CH](F)F CHEMBL1626099
O[1CH]=O CHEMBL430815
O=[1CH]N CHEMBL67413
```
and the corresponding R2.smi might look like
```
[1NH3] CHEMBL1979738
[1ClH] CHEMBL1650264
[1FH] CHEMBL1500738
[1NH3] CHEMBL1626099
[1ClH] CHEMBL430815
[1BrH] CHEMBL67413
```
In this case the identifiers are the same in each file, since these sidechains were
each extracted from different parts of the same molecule. But the tool makes
no assumptions about the sidechains, they can be anything.

## Repleacement Linker Files
Also needed is one or more dicer_data::DicerFrament textproto file(s) of linkers. These might look something like
```
iso: ATT smi: "O=c1[n]([n][1cH]cc1N[1CH3])C" par: "CHEMBL3892294" nat: 10 n: 117
iso: ATT smi: "[1nH]1[n]c(C2[1CH2]C2)c2c1cccc2" par: "CHEMBL3892294" nat: 12 n: 7
iso: ATT smi: "Clc1c[1cH]c(CN[1CH]=O)c(CO)c1" par: "CHEMBL3892292" nat: 13 n: 6
iso: ATT smi: "Clc1c([1CH3])c(CO)c[1cH]c1" par: "CHEMBL3892292" nat: 10 n: 7
iso: ATT smi: "OCCC1C2C([1CH](CC1)C#N)CC[1CH](C)C2C#N" par: "CHEMBL4095668" nat: 18 n: 1
```

which might have been produced by running dicer, and then running `dicer_to_topological_types`.

The next sections will describe ways in which these files can be assembled.

## Assembling Sidechains
The R group decomosition tool [rgroup](rgroup.md) can be used for this task. One invocation
used for tests involved substituted indoles
```
rgroup -v -v -X rname -a -I 1 -s 'c12naaa1aaaa2' -r 0.2 -r 0.8 -z i file.smi > R.smi
```
where we look for substituents at the 2 and 7 (matched atom 8) positions. This generates
a file that might look like
```
O=C1NN=CC2=C1N=C(C)N2 CHEMBL1997979
[1CH4] RG 0.0.0.0 CHEMBL1997979
O1C2=C(N=C1C)C(=NC=N2)N CHEMBL1979738
[1CH4] RG 0.0.0.0 CHEMBL1979738
[1NH3] RG 0.0.1.0 CHEMBL1979738
S=C1NN=CC2=C1N=C(C)N2 CHEMBL1990802
[1CH4] RG 0.0.0.0 CHEMBL1990802
S=C1NC2=C(O1)C=CC=C2O CHEMBL1724381
[1SH2] RG 0.0.0.0 CHEMBL1724381
[1OH2] RG 0.0.1.0 CHEMBL1724381
```
We see that some molecules have found one substituent, others have found two. The script
`rgroup_to_linker_replace` parses this output, and for those molecules for which two
R groups have been identified, creates R1.smi and R2.smi containing the appropriate
fragments.
```
rgroup_to_linker_replace -S R R.smi
```
will create files R1.smi and R2.smi. These files can be used as the sidechain inputs
to `linker_replacement`. Again, these files can be generated by any means, they just
need to have an isotopic atom indicating the attachment point.

And if a more exhaustive enumeration were of interest, trxn can do an exhaustive enumeration
of sets of fragments such as being assembled here.

## Assembling Linkers
There are several ways in which suitable sets of linkers can be assembled. The only
requirement is that they be of dicer_data::DicerFragment textproto format.

[dicer](dicer.md) can be used to fragment collections, identifying
all the two connected fragments in the collection. A typical invocation might be
```
dicer -B fragstat=diced.textproto -B fragstatproto ... collection.smi
dicer_to_topological_types -S DICER diced.textproto
```
this creates files like `DICER_2_3.textproto` which is two connected fragments, linkers,
with 3 bonds between the attachment points. Files like these can be used as the
-L option to `linker_replacement`.

`get_linkers` can be used to get all the inter-ring groups within a set of
molecules, and will be considerably faster than dicer.

## New Molecules
Once the requisite files are assembled, `linker_replacement` can be used to generate
new molecules. First select which linker file(s) you want to use for the replacement
linker. If just one, with all defaults, the invocation might look like
```
linker_replacement -L DICER_2_3.textproto R1.smi R2.smi
```

There are many options available.

### Selecting the Linkers
The linker file(s) could always be subsetted in various ways external to this tool.
[fileconv](fileconv.md) could be used to filter by atom type, [tsubstructure](tsubstructure.md)
could be used to filter by substructure and awk could be used to filter by number of
examplars. But all these functions are built into this tool.

#### -p \<support\>
Only use fragments where the number of examplars is at least \<support\>. 

#### -y \<smarts\> -Y \<query\>
Only use fragments that match any of these queries, specified as either smarts or
query files.

#### -n \<smarts\> -N \<query\>
do NOT use fragments that match any of these queries, specified as either smarts or
query files.

#### -m \<natoms\> -M \<natoms\>
Only use fragments with atom counts within the range of min (-m) and max (-M).

#### -O \<fname\> -O maxdiff=\<n\>
A smiles file containing molecules that define molecular formulae. Only linkers
that differ in molecular formula by at most \<n\> are used. For example you
might put the old linker(s) in this file, and then specify `-O maxdiff=4`
which means that only linkers differing by at most in molecular formula will
be used.

As an example of this, when using an indole as the -O file, and with a maximum
difference of 4, we observe molecules like
![1](Images/linker_replacement1.png)
and
![2](Images/linker_replacement1.png)
where the heterocycle retains interesting elements of similarity to the starting
indole.

It is an interesting question as to whether there should be a `-O mindiff=` directive
to ensure that products are suficiently different from starting molecules.

## Making New Molecules
With the options above used for filtering the candidate linker file(s), the only
option available for controlling the output is the -F option. Here you specify a
[molecule_filter](/src/Molecule_Tools/molecule_filter.proto) textproto specifying
conditions that the products must meet.

An invocation used during testing which exercised most of the options looked like
```
linker_replacement -m 5 -M 12 -F mf.textproto -O scaffold.smi -O maxdiff=6 -p 500 -v
        -L DICER_2_5.textproto R1.smi R2.smi
```

### Performance
Given a large set of inputs, and no final filtering, the tool generates molecules at a rate of about
1M per minute on modern hardware. The rate decreases with time because duplicates are detected and
discarded, and so over time, as more and more molecules have been formed, it becomes increasingly
difficult to generate new molecules.
In a test run that started generating at about 1M molecules per minute, 7.49M molecules were generated in 8 minutes
and 44 seconds.
